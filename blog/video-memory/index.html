<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.61">
<title data-react-helmet="true">ä¸Šä¼ è§†é¢‘å†…å­˜ä¼˜åŒ– | KRN æ–‡æ¡£</title><meta data-react-helmet="true" property="og:title" content="ä¸Šä¼ è§†é¢‘å†…å­˜ä¼˜åŒ– | KRN æ–‡æ¡£"><meta data-react-helmet="true" name="description" content="é¡¹ç›®ä¸­ä½¿ç”¨ react-native-fs ä¸Šä¼ è§†é¢‘æ—¶ç»å¸¸å‡ºç°å†…å­˜æš´æ¶¨ï¼Œå†…å­˜ä¸Šæ¶¨çš„å¹…åº¦æ˜¯è§†é¢‘å¤§å°çš„ 2 å€ï¼Œè€Œä¸”è¿™éƒ¨åˆ†å†…å­˜éšåæ²¡æœ‰é‡Šæ”¾ï¼›å¦‚æ­¤åå¤ä¸Šä¼ è§†é¢‘æœ€ç»ˆå¯¼è‡´ App å†…å­˜ä¸è¶³è€Œå´©æºƒ"><meta data-react-helmet="true" property="og:description" content="é¡¹ç›®ä¸­ä½¿ç”¨ react-native-fs ä¸Šä¼ è§†é¢‘æ—¶ç»å¸¸å‡ºç°å†…å­˜æš´æ¶¨ï¼Œå†…å­˜ä¸Šæ¶¨çš„å¹…åº¦æ˜¯è§†é¢‘å¤§å°çš„ 2 å€ï¼Œè€Œä¸”è¿™éƒ¨åˆ†å†…å­˜éšåæ²¡æœ‰é‡Šæ”¾ï¼›å¦‚æ­¤åå¤ä¸Šä¼ è§†é¢‘æœ€ç»ˆå¯¼è‡´ App å†…å­˜ä¸è¶³è€Œå´©æºƒ"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.d4cf7885.css">
<link rel="preload" href="/styles.b449aec6.js" as="script">
<link rel="preload" href="/runtime~main.d1c5f546.js" as="script">
<link rel="preload" href="/main.6901dc36.js" as="script">
<link rel="preload" href="/1.bdbdbd37.js" as="script">
<link rel="preload" href="/2.bd3da52e.js" as="script">
<link rel="preload" href="/3.ded2d30c.js" as="script">
<link rel="preload" href="/ccc49370.21263af8.js" as="script">
<link rel="preload" href="/b0a3ab04.77304d02.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">KRN æ–‡æ¡£</strong></a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a href="https://kwairn.github.io/components/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Components</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/KwaiRN/KwaiRN.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ğŸŒ</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">KRN æ–‡æ¡£</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://kwairn.github.io/components/" target="_blank" rel="noopener noreferrer" class="menu__link">Components</a></li><li class="menu__list-item"><a href="https://github.com/KwaiRN/KwaiRN.github.io" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--8 col--offset-2"><article><header><h1 class="margin-bottom--sm blogPostTitle_1mse">ä¸Šä¼ è§†é¢‘å†…å­˜ä¼˜åŒ–</h1><div class="margin-vert--md"><time datetime="2020-07-31T00:00:00.000Z" class="blogPostDate_3bQP">July 31, 2020  Â· 2 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/norcy" target="_blank" rel="noreferrer noopener"><img src="https://avatars3.githubusercontent.com/u/8423011?s=460&amp;u=2cc946eff5c03df2f3afd1665cd2a63ffe26eda1&amp;v=4" alt="ChenYing"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/norcy" target="_blank" rel="noreferrer noopener">ChenYing</a></h4><small class="avatar__subtitle">ğŸ˜·</small></div></div></header><section class="markdown"><p>é¡¹ç›®ä¸­ä½¿ç”¨ <a href="https://github.com/itinance/react-native-fs" target="_blank" rel="noopener noreferrer">react-native-fs</a> ä¸Šä¼ è§†é¢‘æ—¶ç»å¸¸å‡ºç°å†…å­˜æš´æ¶¨ï¼Œå†…å­˜ä¸Šæ¶¨çš„å¹…åº¦æ˜¯è§†é¢‘å¤§å°çš„ 2 å€ï¼Œè€Œä¸”è¿™éƒ¨åˆ†å†…å­˜éšåæ²¡æœ‰é‡Šæ”¾ï¼›å¦‚æ­¤åå¤ä¸Šä¼ è§†é¢‘æœ€ç»ˆå¯¼è‡´ App å†…å­˜ä¸è¶³è€Œå´©æºƒ</p><p>æŸ¥çœ‹äº†å…¶æºç çš„æ—¶å€™ï¼Œå‘ç°æœ‰ä¸¤ä¸ªé—®é¢˜å¯¼è‡´å†…å­˜æ³„æ¼</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="ç¬¬ä¸€ä¸ªé—®é¢˜"></a>ç¬¬ä¸€ä¸ªé—®é¢˜<a aria-hidden="true" tabindex="-1" class="hash-link" href="#ç¬¬ä¸€ä¸ªé—®é¢˜" title="Direct link to heading">#</a></h2><p>è¿™æ®µä»£ç æ˜¯å‘é€ä¸Šä¼ è¯·æ±‚</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-objc codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSURLSessionConfiguration *sessionConfiguration = [NSURLSessionConfiguration defaultSessionConfiguration];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSURLSession *session = [NSURLSession sessionWithConfiguration:sessionConfiguration delegate:(id)self delegateQueue:[NSOperationQueue mainQueue]];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">_task = [session dataTaskWithRequest:req completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  NSString * str = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return self-&gt;_params.completeCallback(str, response);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[_task resume];</span></div></div></div></div></div><p>ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ <code>sessionWithConfiguration:delegate:delegateQueue:</code> ä¸­çš„ delegate å‚æ•°ä¼šè¢« NSURLSession å¼ºå¼•ç”¨ï¼Œä¼šå¯¼è‡´ delegate ä¹Ÿå°±æ˜¯ self æ°¸ä¹…ä¸ä¼šé‡Šæ”¾ï¼Œè¿™ç‚¹è¯¥æ¥å£å·²ç»æœ‰å®˜æ–¹æ–‡æ¡£çš„è¯´æ˜</p><blockquote><p>The session object keeps a strong reference to the delegate until your app exits or explicitly invalidates the session. If you do not invalidate the session by calling the invalidateAndCancel or finishTasksAndInvalidate method, your app leaks memory until it exits</p></blockquote><p>è§£å†³æ–¹æ³•æ˜¯åœ¨ä»»åŠ¡ç»“æŸæ—¶è°ƒç”¨ invalidateAndCancel æˆ– finishTasksAndInvalidateï¼Œå¦‚ä¸‹</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-objc codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">_task = [session dataTaskWithRequest:req completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  [session finishTasksAndInvalidate];   // é‡Šæ”¾ delegate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  NSString * str = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return self-&gt;_params.completeCallback(str, response);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}];</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="ç¬¬äºŒä¸ªé—®é¢˜"></a>ç¬¬äºŒä¸ªé—®é¢˜<a aria-hidden="true" tabindex="-1" class="hash-link" href="#ç¬¬äºŒä¸ªé—®é¢˜" title="Direct link to heading">#</a></h2><p>å‘ç°ä¸Šä¼ çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼Œä¸Šä¼ å¤§æ–‡ä»¶çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯å…ˆè¯»å–æ–‡ä»¶åˆ°å†…å­˜ï¼Œç„¶åè®¾ç½®åˆ° HTTPBodyã€‚</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-objc codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSData *fileData = [NSData dataWithContentsOfFile:filepath];    // è¿™é‡Œå†…å­˜ä¼šä¸Šæ¶¨ä¸€ä¸ªè§†é¢‘çš„å¤§å°</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[reqBody appendData:fileData];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[req setHTTPBody:reqBody];      // è¿™é‡Œå†…å­˜ä¹Ÿä¼šä¸Šæ¶¨ä¸€ä¸ªè§†é¢‘çš„å¤§å°</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSURLSessionConfiguration *sessionConfiguration = [NSURLSessionConfiguration defaultSessionConfiguration];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//sessionConfiguration.requestCachePolicy = NSURLRequestReloadIgnoringLocalAndRemoteCacheData; å°è¯•è¿‡æ²¡ç”¨</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSURLSession *session = [NSURLSession sessionWithConfiguration:sessionConfiguration delegate:self delegateQueue:[NSOperationQueue mainQueue]];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">_task = [session dataTaskWithRequest:req completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  [session finishTasksAndInvalidate];   // é‡Šæ”¾ delegate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  NSString * str = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return self-&gt;_params.completeCallback(str, response); // ç½‘ç»œè¯·æ±‚å®Œæˆï¼Œå†…å­˜æ²¡æœ‰é™ä¸‹æ¥ï¼Œæ€»å…±ä¸Šæ¶¨äº† 2 ä¸ªè§†é¢‘çš„å¤§å°</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[_task resume];</span></div></div></div></div></div><p>åŸå› æ˜¯ NSURLSession ä¼š retain äº† req é‡Œçš„ dataï¼Œæ‰€ä»¥å‡ºç°å†…å­˜ä¸é‡Šæ”¾é—®é¢˜</p><p>å¯¹äºå¤§æ–‡ä»¶çš„ä¸Šä¼ åº”è¯¥ä½¿ç”¨æµå¼ä¸Šä¼ çš„æ–¹å¼</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-objc codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSURLSessionConfiguration *sessionConfiguration = [NSURLSessionConfiguration defaultSessionConfiguration];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSURLSession *session = [NSURLSession sessionWithConfiguration:sessionConfiguration delegate:(id)self delegateQueue:[NSOperationQueue mainQueue]];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">_task = [session uploadTaskWithRequest:req</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              fromFile:fileUrl</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     completionHandler:^(NSData *_Nullable data, NSURLResponse *_Nullable response,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                         NSError *_Nullable error) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        [session finishTasksAndInvalidate];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        NSString *str = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        return self-&gt;_params.completeCallback(str, response);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     }];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div></div></div><p>è¿™æ®µä»£ç å–æ¶ˆäº†ç›´æ¥è¯»å–æ–‡ä»¶ç„¶åè®¾ç½® HTTPBody çš„åšæ³•ï¼Œå¹¶ç”¨ <code>uploadTaskWithRequest:fromFile:completionHandler:</code> æ–¹æ³•æ¥ä¸Šä¼ æ–‡ä»¶ï¼Œæµå¼å‘é€ï¼Œè¯»å–ä¸€ç‚¹å‘é€ä¸€ç‚¹ï¼Œè¿™ç§åšæ³•å®è·µä¸‹æ¥å†…å­˜ååˆ†ç¨³å®š</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç <a aria-hidden="true" tabindex="-1" class="hash-link" href="#å®Œæ•´ä»£ç " title="Direct link to heading">#</a></h2><p><a href="http://git.corp.kuaishou.com/team-shenzhen/ios/react-native-fs" target="_blank" rel="noopener noreferrer">å®Œæ•´ä»£ç </a></p></section></article><div><a href="https://github.com/facebook/docusaurus/edit/source/website/blog/blog/2020-07-31-videom-memory.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/start/">Getting Start</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/KwaiRN/KwaiRN.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2020 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.b449aec6.js"></script>
<script src="/runtime~main.d1c5f546.js"></script>
<script src="/main.6901dc36.js"></script>
<script src="/1.bdbdbd37.js"></script>
<script src="/2.bd3da52e.js"></script>
<script src="/3.ded2d30c.js"></script>
<script src="/ccc49370.21263af8.js"></script>
<script src="/b0a3ab04.77304d02.js"></script>
</body>
</html>
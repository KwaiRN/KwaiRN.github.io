---
id: rnfs
title: RNFS å¤§æ–‡ä»¶ä¸Šä¼ é—®é¢˜
author: ChenYing
author_title: ğŸ˜·
author_url: https://github.com/norcy
author_image_url: https://avatars3.githubusercontent.com/u/8423011?s=460&u=2cc946eff5c03df2f3afd1665cd2a63ffe26eda1&v=4
---

é¡¹ç›®ä¸­ä½¿ç”¨ [react-native-fs](https://github.com/itinance/react-native-fs) ä¸Šä¼ è§†é¢‘æ—¶ç»å¸¸å‡ºç°å†…å­˜æš´æ¶¨ï¼Œå†…å­˜ä¸Šæ¶¨çš„å¹…åº¦æ˜¯è§†é¢‘å¤§å°çš„ 2 å€ï¼Œè€Œä¸”è¿™éƒ¨åˆ†å†…å­˜éšåæ²¡æœ‰é‡Šæ”¾ï¼›å¦‚æ­¤åå¤ä¸Šä¼ è§†é¢‘æœ€ç»ˆå¯¼è‡´ App å†…å­˜ä¸è¶³è€Œå´©æºƒ

æŸ¥çœ‹äº†å…¶æºç çš„æ—¶å€™ï¼Œå‘ç°æœ‰ä¸¤ä¸ªé—®é¢˜å¯¼è‡´å†…å­˜æ³„æ¼

<!--truncate-->

## ç¬¬ä¸€ä¸ªé—®é¢˜
è¿™æ®µä»£ç æ˜¯å‘é€ä¸Šä¼ è¯·æ±‚

```objc
NSURLSessionConfiguration *sessionConfiguration = [NSURLSessionConfiguration defaultSessionConfiguration];
NSURLSession *session = [NSURLSession sessionWithConfiguration:sessionConfiguration delegate:(id)self delegateQueue:[NSOperationQueue mainQueue]];
_task = [session dataTaskWithRequest:req completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
  NSString * str = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
  return self->_params.completeCallback(str, response);
}];
[_task resume];
```

ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ `sessionWithConfiguration:delegate:delegateQueue:` ä¸­çš„ delegate å‚æ•°ä¼šè¢« NSURLSession å¼ºå¼•ç”¨ï¼Œä¼šå¯¼è‡´ delegate ä¹Ÿå°±æ˜¯ self æ°¸ä¹…ä¸ä¼šé‡Šæ”¾ï¼Œè¿™ç‚¹è¯¥æ¥å£å·²ç»æœ‰å®˜æ–¹æ–‡æ¡£çš„è¯´æ˜


> The session object keeps a strong reference to the delegate until your app exits or explicitly invalidates the session. If you do not invalidate the session by calling the invalidateAndCancel or finishTasksAndInvalidate method, your app leaks memory until it exits

è§£å†³æ–¹æ³•æ˜¯åœ¨ä»»åŠ¡ç»“æŸæ—¶è°ƒç”¨ invalidateAndCancel æˆ– finishTasksAndInvalidateï¼Œå¦‚ä¸‹

```objc
_task = [session dataTaskWithRequest:req completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
  [session finishTasksAndInvalidate];	// é‡Šæ”¾ delegate
  NSString * str = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
  return self->_params.completeCallback(str, response);
}];
```

## ç¬¬äºŒä¸ªé—®é¢˜
å‘ç°ä¸Šä¼ çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼Œä¸Šä¼ å¤§æ–‡ä»¶çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯å…ˆè¯»å–æ–‡ä»¶åˆ°å†…å­˜ï¼Œç„¶åè®¾ç½®åˆ° HTTPBodyã€‚

```objc
NSData *fileData = [NSData dataWithContentsOfFile:filepath];    // è¿™é‡Œå†…å­˜ä¼šä¸Šæ¶¨ä¸€ä¸ªè§†é¢‘çš„å¤§å°
[reqBody appendData:fileData];
[req setHTTPBody:reqBody];      // è¿™é‡Œå†…å­˜ä¹Ÿä¼šä¸Šæ¶¨ä¸€ä¸ªè§†é¢‘çš„å¤§å°

NSURLSessionConfiguration *sessionConfiguration = [NSURLSessionConfiguration defaultSessionConfiguration];
//sessionConfiguration.requestCachePolicy = NSURLRequestReloadIgnoringLocalAndRemoteCacheData; å°è¯•è¿‡æ²¡ç”¨
NSURLSession *session = [NSURLSession sessionWithConfiguration:sessionConfiguration delegate:self delegateQueue:[NSOperationQueue mainQueue]];
_task = [session dataTaskWithRequest:req completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
  [session finishTasksAndInvalidate];	// é‡Šæ”¾ delegate
  NSString * str = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
  return self->_params.completeCallback(str, response); // ç½‘ç»œè¯·æ±‚å®Œæˆï¼Œå†…å­˜æ²¡æœ‰é™ä¸‹æ¥ï¼Œæ€»å…±ä¸Šæ¶¨äº† 2 ä¸ªè§†é¢‘çš„å¤§å°
}];
[_task resume];
```

åŸå› æ˜¯ NSURLSession ä¼š retain äº† req é‡Œçš„ dataï¼Œæ‰€ä»¥å‡ºç°å†…å­˜ä¸é‡Šæ”¾é—®é¢˜

å¯¹äºå¤§æ–‡ä»¶çš„ä¸Šä¼ åº”è¯¥ä½¿ç”¨æµå¼ä¸Šä¼ çš„æ–¹å¼

```objc
NSURLSessionConfiguration *sessionConfiguration = [NSURLSessionConfiguration defaultSessionConfiguration];
NSURLSession *session = [NSURLSession sessionWithConfiguration:sessionConfiguration delegate:(id)self delegateQueue:[NSOperationQueue mainQueue]];
_task = [session uploadTaskWithRequest:req
                              fromFile:fileUrl
                     completionHandler:^(NSData *_Nullable data, NSURLResponse *_Nullable response,
                                         NSError *_Nullable error) {
                        [session finishTasksAndInvalidate];
                        NSString *str = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
                        return self->_params.completeCallback(str, response);
                     }];

```

è¿™æ®µä»£ç å–æ¶ˆäº†ç›´æ¥è¯»å–æ–‡ä»¶ç„¶åè®¾ç½® HTTPBody çš„åšæ³•ï¼Œå¹¶ç”¨ `uploadTaskWithRequest:fromFile:completionHandler:` æ–¹æ³•æ¥ä¸Šä¼ æ–‡ä»¶ï¼Œæµå¼å‘é€ï¼Œè¯»å–ä¸€ç‚¹å‘é€ä¸€ç‚¹ï¼Œè¿™ç§åšæ³•å®è·µä¸‹æ¥å†…å­˜ååˆ†ç¨³å®š